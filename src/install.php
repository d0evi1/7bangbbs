<?php

define('IN_SAESPOT', 1);
@header("content-Type: text/html; charset=UTF-8");

$sqlfile = dirname(__FILE__) . '/bbs_mysql.sql';
if(!is_readable($sqlfile)) 
{
	exit('数据库文件不存在或者读取失败');
}

$fp = fopen($sqlfile, 'rb');
$sql = fread($fp, 2048000);
fclose($fp);

include (dirname(__FILE__) . '/config.php');
include (dirname(__FILE__) . '/include/mysql.class.php');

$DBM = new DB_MySQL;
$DBM->connect($servername_m, $dbport, $dbusername, $dbpassword, $dbname);
unset($servername_m, $dbusername, $dbpassword);

$DBM->select_db($dbname);
if($DBM->geterrdesc()) 
{
	if(mysql_get_server_info() > '4.1') 
	{
		$DBM->query("CREATE DATABASE $dbname DEFAULT CHARACTER SET $dbcharset");
	}
	else
	{
		$DBM->query("CREATE DATABASE $dbname");
	}
	
	if($DBM->geterrdesc()) 
	{
		exit('指定的数据库不存在, 系统也无法自动建立, 无法安装.<br />');
	} 
	else 
	{
		$DBM->select_db($dbname);
		//成功建立指定数据库
	}
}

$query - $DBM->query("SELECT COUNT(*) FROM bbs_settings", 'SILENT');
if(!$DBM->geterrdesc())
{
	// 清空缓存
	$MMC->flush();
	header('location: /');
	exit('数据已经装好了， 不能重复安装， 若要重装，先删除mysql 里全部数据。 <a href="/">现在直接进入首页</a><br />');
}

runquery($sql);
$DBM->close();

// 清空缓存
$MMC->flush();

// '<br /> 顺利安装完成！<br /><a href="/">点击进入首页</a>';

function runquery($sql) 
{
	global $dbcharset, $DBM;

	$sql = str_replace("\r", "\n", $sql);
	$ret = array();
	$num = 0;
	foreach(explode(";\n", trim($sql)) as $query) 
	{
		$queries = explode("\n", trim($query));
		foreach($queries as $query) 
		{
			$ret[$num] .= $query[0] == '#' ? '' : $query;
		}
		$num++;
	}
	unset($sql);

	foreach($ret as $query) 
	{
		$query = trim($query);
		if($query) 
		{
			if(substr($query, 0, 12) == 'CREATE TABLE') 
			{
				$name = preg_replace("/CREATE TABLE ([a-z0-9_]+) .*/is", "\\1", $query);
				//echo '创建表 '.$name.' ... 成功<br />';
				$DBM->query(createtable($query, $dbcharset));
			} 
			else
			{
				$DBM->query($query);
			}
		}
	}
}

function createtable($sql, $dbcharset) 
{
	$type = strtoupper(preg_replace("/^\s*CREATE TABLE\s+.+\s+\(.+?\).*(ENGINE|TYPE)\s*=\s*([a-z]+?).*$/isU", "\\2", $sql));
	$type = in_array($type, array('MYISAM', 'HEAP')) ? $type : 'MYISAM';
	return preg_replace("/^\s*(CREATE TABLE\s+.+\s+\(.+?\)).*$/isU", "\\1", $sql).(mysql_get_server_info() > '4.1' ? " ENGINE=$type DEFAULT CHARSET=$dbcharset" : " TYPE=$type");
}

header('location: /');

?>
